# Test Cases for Issue #149: agent_chat Outbound Delivery

## Preconditions
1. Two OpenClaw agents (e.g., Graybeard, Newhart) are configured and running. Both use the `agent_chat` plugin.
2. Graybeard has `plugins.entries.agent_chat.enabled = true` but only text capability in the plugin API.
3. The gateway is running the targeted OpenClaw codebase (`nova-openclaw-production`).
4. `agent_chat` table and necessary triggers/notify setups are active in `nova_memory` database.

## Test Case 1: Plugin Outbound Registration
**Objective:** Verify that the `agent_chat` plugin correctly registers its outbound delivery capabilities with OpenClaw, even when lacking `sendMedia` support.
**Steps:**
1. Start the OpenClaw gateway for the agent (`openclaw gateway start`).
2. Observe the startup logs for channel registration.
3. Verify that the gateway lists `agent_chat` as an available outbound channel.
**Expected Result:**
The gateway successfully loads `outbound.sendText` for `agent_chat` and does not throw the `Outbound not configured for channel: agent_chat` error. (Validates that `src/infra/outbound/deliver.ts` correctly handles text-only channels securely using `&&` and not `||` for missing capabilities).

## Test Case 2: Outbound Reply Write to agent_chat Table
**Objective:** Verify that triggering an outbound agent reply results in a properly formatted DB insert into the `agent_chat` table.
**Steps:**
1. Connect directly to the agent's gateway and simulate an outbound text push via `send_agent_message()` or internal CLI tool: `openclaw message send --channel agent_chat --target "agent_chat:requester" --message "Test reply."`
2. Check the `agent_chat` database table in `nova_memory` for a recent row matching the message.
3. Check the `sender` column matches the agent's ID.
**Expected Result:**
The message "Test reply." is successfully written to the `agent_chat` table without errors. The gateway logs indicate successful delivery.

## Test Case 3: Full Round-Trip (Inbound -> Process -> Outbound)
**Objective:** Verify that an incoming message from the database is processed by the agent flow and the reply is transmitted back successfully to the database.
**Steps:**
1. From an external client (or psql), insert a new message into the `agent_chat` table mentioning the agent:
   `INSERT INTO agent_chat (channel, sender, message, mentions) VALUES ('default', 'test_user', '@graybeard hello!', ARRAY['graybeard']);`
2. Wait for the OpenClaw gateway to receive the `LISTEN/NOTIFY` payload and dispatch it to the agent runner.
3. Allow the agent to interpret the prompt and generate a reply.
4. Observe the outbound delivery process via gateway logs.
5. Query the `agent_chat` table.
**Expected Result:**
The agent processes the inbound message without errors. The reply generated by the LLM is written as a new row in the `agent_chat` table with `sender` = 'graybeard', the `reply_to` matching the inserted message ID, and `channel` = 'default'.
