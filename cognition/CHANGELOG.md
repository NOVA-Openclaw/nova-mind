# Changelog

## Unreleased

### Removed (#110 — installer schema cleanup)

- **Duplicate schema management removed from installer** ([#110](https://github.com/nova-openclaw/nova-mind/issues/110)) — `pgschema` is now the single source of truth for database schema. Specifically:
  - `cognition/focus/bootstrap-context/schema/bootstrap-context.sql` — emptied; deprecated tables (`bootstrap_context_universal`, `bootstrap_context_agents`, `bootstrap_context_config`, `bootstrap_context_audit`) are no longer created by this file. Table `agent_bootstrap_context` is managed by `pgschema` via `database/schema.sql`.
  - `cognition/focus/bootstrap-context/install.sh` — removed `psql -f schema/bootstrap-context.sql` step and 4-table verification. Schema is applied by the root `agent-install.sh` via `pgschema`.
  - `cognition/focus/bootstrap-context/sql/management-functions.sql` — removed 5 functions that referenced the deprecated tables: `copy_file_to_bootstrap`, `delete_universal_context`, `delete_agent_context`, `list_all_context`, `get_bootstrap_config`. Remaining functions (`update_universal_context`, `update_agent_context`, `get_agent_bootstrap`, etc.) are unchanged and write to `agent_bootstrap_context`.
  - `cognition/agent-install.sh` — removed direct `psql -f focus/agent_chat/schema.sql` block. `agent_chat` schema is managed exclusively by `pgschema`.
- **Documentation updated** to reflect removed functions and deprecated tables. References to `bootstrap_context_*` tables updated to `agent_bootstrap_context`. See `cognition/focus/bootstrap-context/INSTALLATION_SUMMARY.md`, `docs/MANAGEMENT.md`, and all `fallback/*.md` files.

### Changed (agent_chat modernization — #106, #107)

- **`agent_chat` schema modernized** ([#106](https://github.com/nova-openclaw/nova-cognition/issues/106)) — Column renames and one removal rationalize the table structure for multi-agent messaging:
  - `mentions` → `recipients` (more accurate semantics; column is `NOT NULL` with CHECK)
  - `created_at` → `"timestamp"` (quoted everywhere — `timestamp` is a reserved word in PostgreSQL; type upgraded to `TIMESTAMPTZ`)
  - `channel` column **dropped** — inter-agent messaging uses `sender + recipients` only
- **`send_agent_message()` is now the only insert path** ([#106](https://github.com/nova-openclaw/nova-cognition/issues/106)) — Direct `INSERT` on `agent_chat` is blocked by the new `trg_enforce_agent_chat_function_use` trigger. All inserts must go through `send_agent_message(p_sender, p_message, p_recipients)` (SECURITY DEFINER). The function validates sender and all recipients against the `agents` table; use `ARRAY['*']` for broadcast.
- **`normalize_agent_chat_mentions()` trigger removed** ([#106](https://github.com/nova-openclaw/nova-cognition/issues/106)) — Normalization (lowercase) is now enforced inside `send_agent_message()`.
- **New views and expiry function** ([#106](https://github.com/nova-openclaw/nova-cognition/issues/106)) — Added `v_agent_chat_recent` and `v_agent_chat_stats`; `expire_old_chat()` now uses `"timestamp"` column.
- **pg_notify payload updated** ([#106](https://github.com/nova-openclaw/nova-cognition/issues/106)) — `notify_agent_chat()` now emits `recipients` and drops the `channel` field.
- **`channel.ts` updated to new schema** ([#106](https://github.com/nova-openclaw/nova-cognition/issues/106)) — `fetchUnprocessedMessages` selects `recipients`/`"timestamp"` and also matches broadcast (`'*'`). `insertOutboundMessage` uses `send_agent_message()`. Context routing changed from `agent_chat:channel` to `agent_chat:agentName`.
- **Declarative column renames via `renames.json`** ([#107](https://github.com/nova-openclaw/nova-memory/issues/107)) — `memory/database/renames.json` declares the three `agent_chat` renames/drops. `agent-install.sh` Step 1.5 reads this file and applies `ALTER TABLE … RENAME COLUMN` idempotently before `pgschema plan/apply`.

### Added
- **`agents.json` output is now a bare JSON array** — The `agent-config-sync` plugin writes a plain array (e.g. `[{ "id": "main", ... }, ...]`) instead of a wrapped object. The `$include` directive in `openclaw.json` moved from the root level to `agents.list`: `"list": { "$include": "./agents.json" }`. This lets other `agents.*` keys (defaults, models allowlist) live in `openclaw.json` without being touched by syncs. ([#174](https://github.com/nova-openclaw/nova-cognition/issues/174), [#167](https://github.com/nova-openclaw/nova-cognition/issues/167))
- **`is_default` support in agent sync** — Agents with `is_default = true` in the DB now get `"default": true` in their `agents.json` entry. The key is omitted entirely for non-default agents. ([#174](https://github.com/nova-openclaw/nova-cognition/issues/174), [#168](https://github.com/nova-openclaw/nova-cognition/issues/168))

### Changed
- **Removed models allowlist from `agents.json` output** — `agents.defaults.models` is no longer written by the sync plugin; it stays in `openclaw.json` and is managed there. ([#174](https://github.com/nova-openclaw/nova-cognition/issues/174), [#169](https://github.com/nova-openclaw/nova-cognition/issues/169))
- **Removed system defaults from `agents.json` output** — `agents.defaults.subagents` (e.g. `maxSpawnDepth`) is no longer written by the sync plugin; it stays in `openclaw.json`. The `agent_system_config` table still exists but its values are applied at install time, not at runtime via sync. ([#174](https://github.com/nova-openclaw/nova-cognition/issues/174), [#169](https://github.com/nova-openclaw/nova-cognition/issues/169))
- **Agent filter changed to `instance_type != 'peer'`** — Previously the query used `IN ('primary', 'subagent')`; now it excludes only peer agents, so any new `instance_type` values are automatically included without requiring a query change. ([#174](https://github.com/nova-openclaw/nova-cognition/issues/174), [#170](https://github.com/nova-openclaw/nova-cognition/issues/170))
- **NOTIFY trigger simplified to unconditional** — The `notify_agent_config_changed()` trigger previously fired only on changes to specific columns (model, fallback_models, etc.). It now fires on any row change, so newly added columns (like `is_default`) are automatically captured without trigger updates. ([#174](https://github.com/nova-openclaw/nova-cognition/issues/174), [#170](https://github.com/nova-openclaw/nova-cognition/issues/170))

### Added (continued from #163)
- **System-wide subagent config synced from `agent_system_config` table** — The `agent-config-sync` plugin now also reads the `agent_system_config` table and syncs system-wide defaults (e.g. `maxSpawnDepth`) into `agents.json` under `agents.defaults.subagents`. Changes to the table automatically propagate via the existing `agent_config_changed` LISTEN/NOTIFY channel. A new DB trigger (`notify_system_config_changed`) and migration (`163-system-config-trigger.sql`) are applied by the installer. Supported keys: `max_spawn_depth` (integer, clamped to 1–5 → `maxSpawnDepth`); `max_concurrent_subagents` (reserved for future use). ([#163](https://github.com/nova-openclaw/nova-cognition/issues/163))
- **`agent_system_config` table and trigger in installer** — `agent-install.sh` now ensures the `agent_system_config` table exists, applies the system config trigger migration, and seeds `max_spawn_depth = 5` as the initial default (idempotent: existing values are never overwritten). ([#163](https://github.com/nova-openclaw/nova-cognition/issues/163))
- **`focus/agent-config-sync/README.md`** — New comprehensive README documenting the plugin's dual-table sync, `agent_system_config` schema, supported config keys, configuration layering (installer default → DB → `$include` merge), and the full notification flow. ([#163](https://github.com/nova-openclaw/nova-cognition/issues/163))
- **`allowed_subagents` synced to `subagents.allowAgents`** — The `agent-config-sync` plugin now also syncs the `allowed_subagents` column from the `agents` table to the `subagents.allowAgents` field in `agents.json`, controlling which agents each agent is permitted to spawn. Updating spawn permissions in the DB automatically propagates to the config via the existing LISTEN/NOTIFY mechanism. ([#160](https://github.com/nova-openclaw/nova-cognition/issues/160))
- **Installer creates `notify_agent_config_changed()` DB trigger** — `agent-install.sh` now automatically installs the `notify_agent_config_changed()` trigger function and attaches it to the `agents` table on fresh installs. No manual DB setup required. ([#160](https://github.com/nova-openclaw/nova-cognition/issues/160))
- **`agent-config-sync` extension plugin** — A gateway service that listens for PostgreSQL `LISTEN/NOTIFY` events on the `agent_config_changed` channel and writes `~/.openclaw/agents.json` with current agent model configurations. Uses atomic writes (temp + rename) and includes automatic reconnection with exponential backoff. Performs an initial sync on gateway startup. ([#146](https://github.com/nova-openclaw/nova-cognition/issues/146))
- **`$include` directive for `agents.json`** — `openclaw.json` now includes `"$include": "./agents.json"` so that DB-synced agent configs are merged into the gateway config. Combined with `gateway.reload.mode = "hot"`, changes are picked up without a gateway restart. ([#146](https://github.com/nova-openclaw/nova-cognition/issues/146))
- **Installer generates initial `agents.json`** — `agent-install.sh` now queries the `agents` table at install time to produce a ready-to-use `agents.json`, so the config is correct even before the gateway starts. ([#146](https://github.com/nova-openclaw/nova-cognition/issues/146))
- **Installer sets `gateway.reload.mode`** — The installer ensures hot-reload is enabled (required for the config sync to work); if the mode is unset or `"off"`, it is set to `"hot"`. ([#146](https://github.com/nova-openclaw/nova-cognition/issues/146))
- **`--no-restart` flag for `agent-install.sh`** — the installer now auto-restarts the OpenClaw gateway (if running) after install so plugin changes take effect immediately; pass `--no-restart` to skip this and restart manually later ([#149](https://github.com/nova-openclaw/nova-cognition/issues/149))
- **Shared `pg` dependency install** — `pg` is now installed to `~/.openclaw/node_modules/` (shared across extensions) instead of per-extension `node_modules/`. Old per-extension copies are cleaned up automatically during install ([#149](https://github.com/nova-openclaw/nova-cognition/issues/149))
- **Pre-flight `pg` dependency check in `agent_chat` plugin** — the plugin now verifies that the `pg` module is resolvable at registration time; if missing, it logs a clear error message with install instructions and bails out instead of crashing at runtime ([#149](https://github.com/nova-openclaw/nova-cognition/issues/149))
- **Post-registration self-validation in `agent_chat` plugin** — after registering, the plugin checks that both outbound (`sendText`) and inbound (`gateway/startAccount`) capabilities are present and logs the result, making misconfiguration immediately visible ([#149](https://github.com/nova-openclaw/nova-cognition/issues/149))
- **Prerequisite check in `agent-install.sh`** — installer now verifies that `~/.openclaw/lib/env-loader.sh` (from nova-memory) is present before proceeding; exits with a clear error message and install instructions if missing ([#127](https://github.com/nova-openclaw/nova-cognition/issues/127))

### Removed
- **`agent-config-db` pre-spawn/pre-run hook** — Replaced by the `agent-config-sync` extension plugin. The hook queried the database on every spawn and agent run, adding latency and risking failures; the new plugin syncs proactively via LISTEN/NOTIFY. The installer automatically removes the legacy hook directory and its config entry. ([#146](https://github.com/nova-openclaw/nova-cognition/issues/146))

### Changed
- **`agent-install.sh` Part 4.5 rewritten** — The installer section formerly responsible for the `agent-config-db` hook now installs the `agent-config-sync` extension, builds its TypeScript, configures the plugin, sets up `$include` and hot-reload, and generates the initial `agents.json`. ([#146](https://github.com/nova-openclaw/nova-cognition/issues/146))
